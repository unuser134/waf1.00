<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAF ç®¡ç†é¢æ¿ - DLæ··åˆé˜²ç«å¢™</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ›¡ï¸ DLæ··åˆWAFç®¡ç†ç³»ç»Ÿ</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="system-status"></div>
                    <span>ç³»ç»ŸçŠ¶æ€: <strong id="status-text">æ­£å¸¸</strong></span>
                </div>
                <div class="status-item">
                    <span>æœ€åæ›´æ–°: <strong id="last-update">-</strong></span>
                </div>
                <div class="status-item">
                    <span>ç¼“å­˜æ—¥å¿—: <strong id="logs-count">0</strong></span>
                </div>
            </div>
        </header>
        
        <div class="dashboard-grid">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="card">
                <h2>24å°æ—¶æ”»å‡»æ€»æ•°</h2>
                <div class="stat-value" id="total-attacks">0</div>
                <div class="stat-label">æ£€æµ‹åˆ°çš„æ”»å‡»æ¬¡æ•°</div>
            </div>
            
            <div class="card">
                <h2>é«˜å±æ”»å‡»</h2>
                <div class="stat-value" id="critical-attacks">0</div>
                <div class="stat-label">Critical + Highçº§åˆ«</div>
            </div>
            
            <div class="card">
                <h2>é˜²æŠ¤è¦†ç›–</h2>
                <div class="stat-value" id="rule-count">0</div>
                <div class="stat-label">å·²åŠ è½½è§„åˆ™æ•°</div>
            </div>
        </div>
        
        <!-- å›¾è¡¨ -->
        <div class="card">
            <h2>æ”»å‡»è¶‹åŠ¿ï¼ˆå°æ—¶ï¼‰</h2>
            <div class="chart-container">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('attacks')">æœ€è¿‘æ”»å‡»</button>
                <button class="tab" onclick="switchTab('rules')">è§„åˆ™ç®¡ç†</button>
                <button class="tab" onclick="switchTab('whitelist')">ç™½åå•</button>
                <button class="tab" onclick="switchTab('deploy')">éƒ¨ç½²</button>
            </div>
            
            <!-- æœ€è¿‘æ”»å‡» -->
            <div id="attacks" class="tab-content active">
                <div class="action-buttons">
                    <button onclick="refreshLogs()">åˆ·æ–°æ—¥å¿—</button>
                    <button onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
                    <button class="danger" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                </div>
                <table class="logs-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>æ”»å‡»ç±»å‹</th>
                            <th>ä¸¥é‡ç¨‹åº¦</th>
                            <th>æ¥æºIP</th>
                            <th>æ£€æµ‹æ–¹æ³•</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body">
                        <tr><td colspan="5" class="muted-center">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- è§„åˆ™ç®¡ç† -->
            <div id="rules" class="tab-content">
                <div class="action-buttons">
                    <button onclick="reloadRules()">é‡æ–°åŠ è½½è§„åˆ™</button>
                </div>
                <div id="rules-info">
                    <div id="rules-detail"></div>
                </div>
            </div>
            
            <!-- ç™½åå• -->
            <div id="whitelist" class="tab-content">
                <div class="action-buttons">
                    <input type="text" id="whitelist-input" placeholder="è¾“å…¥IPæˆ–è·¯å¾„" class="input-flex">
                    <button onclick="addWhitelist()">æ·»åŠ </button>
                </div>
                <div id="whitelist-list">åŠ è½½ä¸­...</div>
            </div>

            <!-- éƒ¨ç½²/æ§åˆ¶ -->
            <div id="deploy" class="tab-content">
                <h3>éƒ¨ç½²ä¸æ§åˆ¶</h3>
                <div class="action-buttons">
                    <label class="label-inline">è¿è¡Œæ¨¡å¼:
                        <select id="mode-select">
                            <option value="protection">ğŸ›¡ï¸ ä¿æŠ¤æ¨¡å¼</option>
                            <option value="detection">ğŸ“Š æ£€æµ‹æ¨¡å¼</option>
                        </select>
                    </label>
                    <button onclick="setMode()">è®¾ç½®æ¨¡å¼</button>
                </div>

                <div class="action-buttons">
                    <input id="proxy-backend" type="text" placeholder="åç«¯åœ°å€ï¼Œä¾‹å¦‚ http://localhost:8081" class="input-flex">
                    <input id="proxy-port" type="number" value="8080" class="input-small">
                    <button onclick="startProxy()">å¯åŠ¨ä»£ç†</button>
                    <button class="danger" onclick="stopProxy()">åœæ­¢ä»£ç†</button>
                </div>

                <div id="deploy-status">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    
    <script>
        // å®šæ—¶åˆ·æ–°æ•°æ®
        setInterval(refreshData, 5000);
        
        function refreshData() {
            // åˆ·æ–°ç»Ÿè®¡æ•°æ®
            fetch('/api/stats?hours=24')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('total-attacks').textContent = data.total_attacks || 0;
                    
                    const critical = (data.by_severity?.critical || 0) + (data.by_severity?.high || 0);
                    document.getElementById('critical-attacks').textContent = critical;
                    
                    updateTrendsChart(data.hourly_trend || {});
                })
                .catch(e => console.error('åˆ·æ–°ç»Ÿè®¡å¤±è´¥:', e));
            
            // åˆ·æ–°æ—¥å¿—è®¡æ•°
            fetch('/api/logs?limit=1')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('logs-count').textContent = data.count || 0;
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString('zh-CN');
                })
                .catch(e => console.error('åˆ·æ–°æ—¥å¿—è®¡æ•°å¤±è´¥:', e));
        }
        
        function switchTab(name) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(name).classList.add('active');
            event.target.classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (name === 'attacks') refreshLogs();
            else if (name === 'rules') loadRules();
            else if (name === 'whitelist') loadWhitelist();
        }
        
        function refreshLogs() {
            fetch('/api/logs?limit=50')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('logs-body');
                    if (data.logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="muted-center">æš‚æ— æ”»å‡»æ—¥å¿—</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = data.logs.map(log => `
                        <tr>
                            <td>${log.timestamp?.substring(11, 19) || '-'}</td>
                            <td>${log.category || '-'}</td>
                            <td><span class="severity-${log.severity || 'unknown'}">${log.severity || '-'}</span></td>
                            <td>${log.source_ip || '-'}</td>
                            <td>${log.detection_method || '-'}</td>
                        </tr>
                    `).join('');
                })
                .catch(e => console.error('åˆ·æ–°æ—¥å¿—å¤±è´¥:', e));
        }
        
        function reloadRules() {
            fetch('/api/rules/reload', {method: 'POST'})
                .then(r => r.json())
                .then(data => alert('è§„åˆ™å·²é‡æ–°åŠ è½½'))
                .catch(e => alert('é‡æ–°åŠ è½½è§„åˆ™å¤±è´¥: ' + e));
        }
        
        function loadRules() {
            fetch('/api/rules')
                .then(r => r.json())
                .then(data => {
                    const detail = document.getElementById('rules-detail');
                    let html = `
                        <div class="rules-card">
                            <h4 class="rules-heading">ğŸ“Š è§„åˆ™ç»Ÿè®¡ä¿¡æ¯</h4>
                            <div class="rules-grid">
                                <div class="rules-stat rules-stat-primary">
                                    <div class="stat-label">æ€»è§„åˆ™æ•°</div>
                                    <div class="stat-value">${data.total_rules || 0}</div>
                                </div>
                                <div class="rules-stat rules-stat-success">
                                    <div class="stat-label">å·²å¯ç”¨è§„åˆ™</div>
                                    <div class="stat-value">${data.enabled_rules || 0}</div>
                                </div>
                            </div>
                        </div>
                        <div class="rules-card">
                            <h4 class="rules-heading">ğŸ·ï¸ æ”»å‡»ç±»åˆ«åˆ†å¸ƒ</h4>
                            <div class="category-grid">
                    `;
                    
                    const categories = {
                        'sql_injection': 'SQLæ³¨å…¥',
                        'xss': 'è·¨ç«™è„šæœ¬',
                        'directory_traversal': 'ç›®å½•éå†',
                        'file_inclusion': 'æ–‡ä»¶åŒ…å«',
                        'malicious_file': 'æ¶æ„æ–‡ä»¶'
                    };
                    
                    for (const [key, label] of Object.entries(categories)) {
                        const count = data.by_category?.[key] || 0;
                        if (count > 0) {
                            html += `<div class="category-card">
                                <div class="category-label">${label}</div>
                                <div class="category-value">${count}</div>
                            </div>`;
                        }
                    }

                    html += `</div></div><div class="rules-card"><h4 class="rules-heading">âš ï¸ ä¸¥é‡åº¦åˆ†å¸ƒ</h4><div class="severity-grid">
                    `;
                    const severities = {
                        'critical': { label: 'ä¸¥é‡', color: '#F44336' },
                        'high': { label: 'é«˜', color: '#FF9800' },
                        'medium': { label: 'ä¸­', color: '#FFC107' }
                    };
                    
                    for (const [key, info] of Object.entries(severities)) {
                        const count = data.by_severity?.[key] || 0;
                        html += `<div class="severity-card severity-card-${key}">
                            <div class="severity-label">${info.label}</div>
                            <div class="severity-value">${count}</div>
                        </div>`;
                    }
                    
                    html += `</div></div>`;
                    detail.innerHTML = html;
                })
                .catch(e => console.error('åŠ è½½è§„åˆ™å¤±è´¥:', e));
        }
        
        function loadWhitelist() {
            fetch('/api/whitelist')
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById('whitelist-list');
                    if (data.whitelist.length === 0) {
                        list.innerHTML = '<p class="muted">ç™½åå•ä¸ºç©º</p>';
                        return;
                    }

                    list.innerHTML = '<ul class="whitelist-list">' +
                        data.whitelist.map(item => `
                            <li class="whitelist-item">
                                <span>${item}</span>
                                <button class="btn-danger btn-small" onclick="removeWhitelist('${item}')">åˆ é™¤</button>
                            </li>
                        `).join('') +
                        '</ul>';
                })
                .catch(e => console.error('åŠ è½½ç™½åå•å¤±è´¥:', e));
        }
        
        function exportLogs() {
            window.location.href = '/api/export/logs';
        }
        
        function clearLogs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) {
                alert('æ—¥å¿—å·²æ¸…ç©º');
            }
        }
        
        function addWhitelist() {
            const input = document.getElementById('whitelist-input');
            const item = input.value.trim();
            if (!item) return;
            
            fetch('/api/whitelist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({item})
            })
            .then(r => r.json())
            .then(() => {
                input.value = '';
                loadWhitelist();
            })
            .catch(e => alert('æ·»åŠ å¤±è´¥: ' + e));
        }
        
        function removeWhitelist(item) {
            fetch(`/api/whitelist/${encodeURIComponent(item)}`, {method: 'DELETE'})
                .then(r => r.json())
                .then(() => loadWhitelist())
                .catch(e => alert('åˆ é™¤å¤±è´¥: ' + e));
        }
        
        let trendsChart = null;
        
        function updateTrendsChart(data) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            const labels = Object.keys(data).sort();
            const values = labels.map(l => data[l]);
            
            if (trendsChart) trendsChart.destroy();
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'æ”»å‡»æ•°é‡',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {stepSize: 1}
                        }
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–
        refreshData();
        refreshLogs();
        // éƒ¨ç½²çŠ¶æ€è½®è¯¢
        setInterval(getDeployStatus, 5000);

        function getDeployStatus() {
            fetch('/api/deploy/status')
                .then(r => r.json())
                .then(data => {
                    const el = document.getElementById('deploy-status');
                    const modeLabel = data.mode === 'protection' ? 'ğŸ›¡ï¸ ä¿æŠ¤æ¨¡å¼' : 'ğŸ“Š æ£€æµ‹æ¨¡å¼';
                    const proxyLabel = data.proxy.status === 'running' ? 'âœ… è¿è¡Œä¸­' : 'â¹ï¸ å·²åœæ­¢';
                    const pidInfo = data.proxy.pid ? ` (PID: ${data.proxy.pid})` : '';
                    
                    el.innerHTML = `
                        <div class="deploy-status-grid">
                            <div class="deploy-card deploy-card-ok">
                                <div class="small-label">å½“å‰æ¨¡å¼</div>
                                <div class="deploy-value">${modeLabel}</div>
                            </div>
                            <div class="deploy-card ${data.proxy.status === 'running' ? 'deploy-card-ok' : 'deploy-card-stopped'}">
                                <div class="small-label">ä»£ç†çŠ¶æ€</div>
                                <div class="deploy-value">${proxyLabel}${pidInfo}</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('mode-select').value = data.mode;
                })
                .catch(e => console.error('è·å–éƒ¨ç½²çŠ¶æ€å¤±è´¥:', e));
        }

        function setMode() {
            const mode = document.getElementById('mode-select').value;
            fetch('/api/deploy/mode', {method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({mode})})
                .then(r => r.json())
                .then(() => alert('æ¨¡å¼å·²è®¾ç½®'))
                .catch(e => alert('è®¾ç½®æ¨¡å¼å¤±è´¥: '+e));
        }

        function startProxy() {
            const backend = document.getElementById('proxy-backend').value.trim();
            const port = parseInt(document.getElementById('proxy-port').value, 10) || 8080;
            if (!backend) { alert('è¯·è¾“å…¥åç«¯åœ°å€'); return; }
            fetch('/api/deploy/proxy/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({backend, port})})
                .then(r => r.json())
                .then(data => { if (data.status === 'success') alert('ä»£ç†å¯åŠ¨æˆåŠŸ: pid ' + data.pid); else alert('å¯åŠ¨å¤±è´¥: '+(data.message||JSON.stringify(data))); })
                .catch(e => alert('å¯åŠ¨ä»£ç†å¤±è´¥: '+e));
        }

        function stopProxy() {
            fetch('/api/deploy/proxy/stop', {method:'POST'})
                .then(r => r.json())
                .then(data => { if (data.status === 'success') alert('ä»£ç†å·²åœæ­¢'); else alert('åœæ­¢å¤±è´¥: '+(data.message||JSON.stringify(data))); })
                .catch(e => alert('åœæ­¢ä»£ç†å¤±è´¥: '+e));
        }
    </script>
</body>
</html>
