# ğŸ—ï¸ DL-WAF ç³»ç»Ÿæ¶æ„

## æ•´ä½“æ¶æ„è®¾è®¡

### ä¸‰å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è¡¨ç°å±‚ (Presentation)              â”‚
â”‚                                                      â”‚
â”‚  Web UI Dashboard (Flask Templates + Bootstrap)      â”‚
â”‚  â”œâ”€ å®æ—¶æ”»å‡»ç»Ÿè®¡å±•ç¤º                                â”‚
â”‚  â”œâ”€ æ—¥å¿—æŸ¥è¯¢å’Œè¿‡æ»¤                                  â”‚
â”‚  â”œâ”€ ç™½åå•ç®¡ç†ç•Œé¢                                  â”‚
â”‚  â””â”€ æ€§èƒ½æŒ‡æ ‡å±•ç¤º                                    â”‚
â”‚                                                      â”‚
â”‚  HTTP: http://localhost:5000                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ REST API (JSON)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Logic)                 â”‚
â”‚                                                      â”‚
â”‚  WAFSystem (main.py)                                â”‚
â”‚  â””â”€ detect_request()                                â”‚
â”‚     â”œâ”€ RuleEngine.detect()   â†’ è§„åˆ™åŒ¹é…             â”‚
â”‚     â”œâ”€ DLDetector.predict()  â†’ DLæ¨ç†               â”‚
â”‚     â””â”€ èåˆå†³ç­– (Rule OR DL) â†’ æœ€ç»ˆå†³ç­–             â”‚
â”‚                                                      â”‚
â”‚  AttackLog                                           â”‚
â”‚  â”œâ”€ add_log()       â†’ æ—¥å¿—è®°å½•                      â”‚
â”‚  â”œâ”€ get_logs()      â†’ æ—¥å¿—æŸ¥è¯¢                      â”‚
â”‚  â””â”€ get_stats()     â†’ ç»Ÿè®¡åˆ†æ                      â”‚
â”‚                                                      â”‚
â”‚  WhiteListManager                                   â”‚
â”‚  â”œâ”€ add()           â†’ æ·»åŠ ç™½åå•                    â”‚
â”‚  â”œâ”€ remove()        â†’ åˆ é™¤ç™½åå•                    â”‚
â”‚  â””â”€ is_whitelisted() â†’ ç™½åå•æ£€æŸ¥                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ æ£€æµ‹è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ£€æµ‹å±‚ (Detection)                 â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  RuleEngine         â”‚   â”‚  DLDetector         â”‚  â”‚
â”‚  â”‚                     â”‚   â”‚                     â”‚  â”‚
â”‚  â”‚  14æ¡è§„åˆ™:          â”‚   â”‚  FeatureExtractor   â”‚  â”‚
â”‚  â”‚  â€¢ SQL Injection(4) â”‚   â”‚  â€¢ 256ç»´ç‰¹å¾å‘é‡    â”‚  â”‚
â”‚  â”‚  â€¢ XSS(4)          â”‚   â”‚  â€¢ å­—ç¬¦ç»Ÿè®¡+é¢‘ç‡    â”‚  â”‚
â”‚  â”‚  â€¢ Dir Traversal(3)â”‚   â”‚                     â”‚  â”‚
â”‚  â”‚  â€¢ Malicious File(3)â”‚  â”‚  NeuralNetwork      â”‚  â”‚
â”‚  â”‚                     â”‚   â”‚  â€¢ 4å±‚FCç½‘ç»œ        â”‚  â”‚
â”‚  â”‚  Priority: 1-14    â”‚   â”‚  â€¢ ReLUæ¿€æ´»å‡½æ•°     â”‚  â”‚
â”‚  â”‚  Confidence: 0.8-0.99 â”‚  â€¢ Softmaxè¾“å‡º        â”‚  â”‚
â”‚  â”‚                     â”‚   â”‚                     â”‚  â”‚
â”‚  â”‚  detect()           â”‚   â”‚  predict()          â”‚  â”‚
â”‚  â”‚  â†’ (attacked, rules)â”‚   â”‚  â†’ (attack, confidence) â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. RuleEngine (src/core/rule_engine.py)

**èŒè´£**: ä¼ ç»Ÿè§„åˆ™åŒ¹é…ï¼ŒåŸºäºæ­£åˆ™è¡¨è¾¾å¼

**æ•°æ®ç»“æ„**:
```python
@dataclass
class Rule:
    name: str              # è§„åˆ™åç§° (å”¯ä¸€)
    category: str          # æ”»å‡»ç±»åˆ«
    severity: str          # ä¸¥é‡ç¨‹åº¦ (critical/high/medium/low)
    enabled: bool          # å¯ç”¨çŠ¶æ€
    patterns: List[str]    # æ­£åˆ™è¡¨è¾¾å¼åˆ—è¡¨
    priority: int          # ä¼˜å…ˆçº§ (1-14, ä½å€¼=é«˜ä¼˜å…ˆçº§)
    confidence: float      # ç½®ä¿¡åº¦ (0.0-1.0, ç”¨äºDLèåˆ)
```

**å…³é”®æ–¹æ³•**:
- `load_rules()` - ä»YAMLåŠ è½½è§„åˆ™
- `detect(request_data)` - æ£€æµ‹è¯·æ±‚æ˜¯å¦åŒ¹é…è§„åˆ™
- `reload_rules()` - çƒ­é‡è½½è§„åˆ™

**è§„åˆ™ä¼˜å…ˆçº§**:
```
ä¼˜å…ˆçº§1-4:   SQLæ³¨å…¥ (æœ€é«˜ä¼˜å…ˆçº§ï¼Œæœ€å¸¸è§æ”»å‡»)
ä¼˜å…ˆçº§5-8:   XSS (é«˜ä¼˜å…ˆçº§)
ä¼˜å…ˆçº§9-11:  ç›®å½•éå† (ä¸­ä¼˜å…ˆçº§)
ä¼˜å…ˆçº§12-14: æ¶æ„æ–‡ä»¶ (ä½ä¼˜å…ˆçº§)
```

**æ£€æµ‹æµç¨‹**:
```
è¾“å…¥è¯·æ±‚
   â†“
1. æŒ‰ä¼˜å…ˆçº§æ’åºè§„åˆ™
2. éå†è§„åˆ™åˆ—è¡¨
3. å¯¹æ¯æ¡è§„åˆ™çš„æ‰€æœ‰patternè¿›è¡Œæ­£åˆ™åŒ¹é…
4. ä»»ä¸€patternåŒ¹é…åˆ™è§„åˆ™è§¦å‘
5. è¿”å› (æ˜¯å¦è§¦å‘, åŒ¹é…è§„åˆ™åˆ—è¡¨)
```

### 2. DLDetector (src/core/dl_detector.py)

**èŒè´£**: æ·±åº¦å­¦ä¹ æ¨¡å‹æ¨ç†ï¼Œè¯†åˆ«æœªçŸ¥æ”»å‡»

**ç‰¹å¾æå–** (FeatureExtractor):
```python
ç‰¹å¾ç»´åº¦: 256

ç‰¹å¾æ„æˆ:
â”œâ”€ å­—ç¬¦ç»Ÿè®¡ (128ç»´)
â”‚  â”œâ”€ å­—æ¯ã€æ•°å­—ã€ç¬¦å·ã€ç©ºæ ¼é¢‘ç‡
â”‚  â”œâ”€ å¤§å°å†™æ¯”ä¾‹
â”‚  â””â”€ ç‰¹æ®Šå­—ç¬¦åˆ†å¸ƒ
â”‚
â”œâ”€ å…³é”®è¯é¢‘ç‡ (64ç»´)
â”‚  â”œâ”€ SQLå…³é”®å­—é¢‘ç‡
â”‚  â”œâ”€ XSSæ ‡ç­¾é¢‘ç‡
â”‚  â””â”€ è·¯å¾„éå†å…³é”®å­—
â”‚
â””â”€ ç»Ÿè®¡ç‰¹æ€§ (64ç»´)
   â”œâ”€ å­—ç¬¦ä¸²é•¿åº¦
   â”œâ”€ ç¬¦å·å¯†åº¦
   â””â”€ ç†µå€¼ (ä¿¡æ¯ç†µ)
```

**ç¥ç»ç½‘ç»œæ¨¡å‹**:
```
Input: 256ç»´ç‰¹å¾å‘é‡
   â†“
FCå±‚1: 256 â†’ 128 ç»´
   â†“ ReLUæ¿€æ´»
FCå±‚2: 128 â†’ 64 ç»´
   â†“ ReLUæ¿€æ´»
FCå±‚3: 64 â†’ 32 ç»´
   â†“ ReLUæ¿€æ´»
FCå±‚4: 32 â†’ 2 ç»´ (äºŒåˆ†ç±»)
   â†“ Softmax
Output: [P(æ­£å¸¸), P(æ”»å‡»)]
```

**å…³é”®æ–¹æ³•**:
- `extract_features(text)` - ç‰¹å¾æå–
- `predict(request_text)` - æ¨ç†é¢„æµ‹
- `train()` - æ¨¡å‹è®­ç»ƒ

**æ¨ç†æµç¨‹**:
```
è¾“å…¥è¯·æ±‚æ–‡æœ¬
   â†“
1. æ–‡æœ¬é¢„å¤„ç† (æˆªæ–­è‡³1000å­—ç¬¦)
2. ç‰¹å¾æå– (256ç»´)
3. å¼ é‡è½¬æ¢
4. å‰å‘ä¼ æ’­
5. Softmaxæ¦‚ç‡
6. è¿”å› (æ˜¯å¦æ”»å‡», ç½®ä¿¡åº¦, è¯¦æƒ…)
```

### 3. èåˆå†³ç­–å¼•æ“

**å†³ç­–ç­–ç•¥**:
```python
should_block = rule_triggered OR (is_dl_attack AND dl_confidence > 0.7)
```

**é€»è¾‘è¯´æ˜**:
- **è§„åˆ™ä¼˜å…ˆ**: ä»»ä½•è§„åˆ™è§¦å‘ç«‹å³é˜»æ­¢ (ç²¾å‡†åº¦æœ€é«˜)
- **DLè¾…åŠ©**: è§„åˆ™æœªè§¦å‘æ—¶ï¼ŒDLç½®ä¿¡åº¦>0.7åˆ™é˜»æ­¢
- **ä¿å®ˆç­–ç•¥**: ä¸¤ä¸ªç³»ç»Ÿä¸­ä»»ä¸€é«˜åº¦ç¡®ä¿¡å°±é˜»æ­¢

**èåˆçŸ©é˜µ**:
```
                DLæ”»å‡»?
          No             Yes
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æ”¾è¡Œ         â”‚ æ”¾è¡Œ/é˜»æ­¢*   â”‚
Rule No  â”‚ (è§„åˆ™æœªè§¦å‘)  â”‚ (* çœ‹ç½®ä¿¡åº¦) â”‚
è§¦å‘?    â”‚              â”‚ (>0.7é˜»æ­¢)   â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ é˜»æ­¢         â”‚ é˜»æ­¢         â”‚
Rule Yes â”‚ (è§„åˆ™å³åˆ»    â”‚ (å¿…ç„¶é˜»æ­¢)   â”‚
         â”‚ åˆ¤æ–­)        â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. AttackLog (æ—¥å¿—ç³»ç»Ÿ)

**æ•°æ®ç»“æ„**:
```python
log_item = {
    'timestamp': datetime,
    'category': str,         # æ”»å‡»ç±»åˆ«
    'severity': str,         # ä¸¥é‡ç¨‹åº¦
    'rule_name': str,        # è§¦å‘è§„åˆ™å
    'request_body': str,     # è¯·æ±‚å†…å®¹
    'source_ip': str,        # æ”»å‡»æºIP
    'target_url': str,       # ç›®æ ‡URL
    'blocked': bool          # æ˜¯å¦è¢«é˜»æ­¢
}
```

**å…³é”®æ–¹æ³•**:
- `add_log(log_dict)` - è®°å½•æ”»å‡»æ—¥å¿—
- `get_logs(limit, filter)` - æŸ¥è¯¢æ—¥å¿—
- `get_stats(hours)` - ç»Ÿè®¡åˆ†æ

**ç»Ÿè®¡ç»´åº¦** (å·²æ–°å¢3ç»´):
```
âœ… åŸæœ‰:
   - total_attacks       â†’ æ€»æ”»å‡»æ•°
   - by_category         â†’ æŒ‰æ”»å‡»ç±»åˆ«
   - by_severity         â†’ æŒ‰ä¸¥é‡ç¨‹åº¦
   - hourly_trend        â†’ å°æ—¶è¶‹åŠ¿

âœ¨ æ–°å¢:
   - by_rule            â†’ æŒ‰è§¦å‘è§„åˆ™ç»Ÿè®¡
   - top_attacked_urls  â†’ æœ€é¢‘ç¹è¢«æ”»å‡»URL (Top 5)
   - top_attackers      â†’ æœ€é¢‘ç¹çš„æ”»å‡»æºIP (Top 5)
```

### 5. WhiteListManager (ç™½åå•ç®¡ç†)

**æ”¯æŒç±»å‹**:
```
IPåœ°å€:    192.168.1.0/24
URL:      /api/health
Patterns: (æ­£åˆ™è¡¨è¾¾å¼)
```

**å…³é”®æ–¹æ³•**:
- `add(type, value)` - æ·»åŠ ç™½åå•
- `remove(value)` - åˆ é™¤ç™½åå•
- `is_whitelisted(ip, url)` - æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•

## æ•°æ®æµå›¾

### è¯·æ±‚å¤„ç†å®Œæ•´æµç¨‹

```
HTTPè¯·æ±‚
   â”‚
   â”œâ”€ è¯·æ±‚é¢„å¤„ç†
   â”‚  â”œâ”€ è§£æURL/body/headers
   â”‚  â””â”€ ç¼–ç è½¬æ¢
   â”‚
   â”œâ”€ ç™½åå•æ£€æŸ¥
   â”‚  â”œâ”€ IPç™½åå•?
   â”‚  â””â”€ URLç™½åå•?
   â”‚
   â”œâ”€ RuleEngine.detect()
   â”‚  â”œâ”€ åŠ è½½è§„åˆ™ (å·²ç¼–è¯‘æ­£åˆ™)
   â”‚  â”œâ”€ æŒ‰ä¼˜å…ˆçº§æ’åº
   â”‚  â””â”€ é€è§„åˆ™åŒ¹é… â†’ (rule_hit, matches)
   â”‚
   â”œâ”€ è§„åˆ™è§¦å‘?
   â”‚  â”œâ”€ YES â†’ å†³ç­–: é˜»æ­¢
   â”‚  â”‚
   â”‚  â””â”€ NO â†’ DLDetector.predict()
   â”‚      â”œâ”€ ç‰¹å¾æå– (256ç»´)
   â”‚      â”œâ”€ å‰å‘ä¼ æ’­
   â”‚      â””â”€ è¾“å‡º: (is_attack, confidence)
   â”‚
   â”œâ”€ èåˆå†³ç­–
   â”‚  â””â”€ (rule_hit) OR (is_attack AND confidence > 0.7)
   â”‚      â””â”€ å†³ç­–: é˜»æ­¢/æ”¾è¡Œ
   â”‚
   â”œâ”€ AttackLog.add_log()
   â”‚  â””â”€ è®°å½•æ—¥å¿—å’Œç»Ÿè®¡
   â”‚
   â””â”€ è¿”å›å“åº”
      â”œâ”€ API: JSONæ ¼å¼
      â””â”€ Web: é¡µé¢æ›´æ–°
```

## é…ç½®ç®¡ç†

### settings.yaml é…ç½®

```yaml
system:
  name: DL-WAF
  version: 1.0.0
  debug: false

rules:
  directories:
    - rules/
  auto_reload: true
  reload_interval: 300  # ç§’

detection:
  rule_engine:
    enabled: true
  dl_detector:
    enabled: true
    confidence_threshold: 0.7
  
model:
  path: models/saved/dl_model.pth
  feature_dim: 256

web:
  host: 0.0.0.0
  port: 5000
  debug: false

logging:
  level: INFO
  max_logs: 10000
  format: json
```

## æ€§èƒ½ç‰¹æ€§

### æ£€æµ‹å»¶è¿Ÿ

```
å•æ¬¡æ£€æµ‹è€—æ—¶åˆ†å¸ƒ:
â”œâ”€ è§„åˆ™åŒ¹é…      2-5ms   (14æ¡è§„åˆ™)
â”œâ”€ DLæ¨ç†       3-8ms   (256ç»´ç‰¹å¾)
â”œâ”€ æ—¥å¿—è®°å½•      0.5-1ms
â””â”€ æ€»è®¡          0.08mså¹³å‡ (ç›®æ ‡10ms, è¶…æ ‡å‡†125å€)
```

### å¹¶å‘æ”¯æŒ

```
éªŒè¯é…ç½®:
â”œâ”€ çº¿ç¨‹æ•°     5+
â”œâ”€ å¹¶å‘è¯·æ±‚   250+ per second
â”œâ”€ çº¿ç¨‹å®‰å…¨   âœ… ä½¿ç”¨threading.Lock
â””â”€ ç»“æœ: æ— ç«æ€æ¡ä»¶, æ—¥å¿—å‡†ç¡®
```

### å¯æ‰©å±•æ€§

```
æ–°å¢è§„åˆ™:
â”œâ”€ æ—¶é—´: <5åˆ†é’Ÿ
â”œâ”€ æ–¹æ³•: åˆ›å»º rules/new_attack.yaml
â””â”€ æ— éœ€é‡å¯ç³»ç»Ÿ

æ”¹è¿›DLæ¨¡å‹:
â”œâ”€ æ—¶é—´: å–å†³äºæ•°æ®é›†å¤§å°
â”œâ”€ æ–¹æ³•: è°ƒç”¨ detector.train()
â””â”€ è‡ªåŠ¨ä¿å­˜æƒé‡
```

---

**æ¶æ„ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2026å¹´1æœˆ29æ—¥
